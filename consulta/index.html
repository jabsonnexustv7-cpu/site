<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consulta de Cobertura ‚Äî CEP e Fachada</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#f6f7f9; }
    .wrap { max-width: 860px; margin: 28px auto; padding: 0 16px; }
    .card { background:#fff; border:1px solid #e6e8ee; border-radius:12px; padding:16px; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .muted { font-size:12px; color:#6b7280; }
    .tabs { display:flex; gap:8px; margin: 12px 0; }
    .tab { border:1px solid #d7dbe6; background:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
    .tab.active { border-color:#111827; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    label { display:block; font-size:12px; color:#4b5563; margin:10px 0 6px; }
    input, textarea { width:100%; padding:10px; border:1px solid #d7dbe6; border-radius:10px; font-size:14px; background:#fff; }
    textarea { min-height: 90px; resize: vertical; }
    .actions { margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #111827; background:#111827; color:#fff; font-weight:800; cursor:pointer; }
    button.secondary { background:#fff; color:#111827; border-color:#d7dbe6; }
    .result { margin-top:12px; padding:12px; border-radius:10px; background:#f3f4f6; border:1px solid #e5e7eb; }
    .hide { display:none; }
    .ok { color:#065f46; font-weight:900; }
    .bad { color:#991b1b; font-weight:900; }
    .warn { color:#92400e; font-weight:900; }
    .spinner { width:14px; height:14px; border:2px solid #cbd5e1; border-top-color:#111827; border-radius:50%; animation:spin 0.7s linear infinite; display:inline-block; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#111827; color:#fff; font-size:12px; font-weight:800; }
    a { color:#111827; }
    code { background:#eef2ff; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Consulta de Cobertura</h1>
      <div class="muted">Consulta por CEP (Firestore) e envio de Fachada (Storage) para an√°lise.</div>

      <div class="tabs">
        <button class="tab active" id="tabCep" type="button">Por CEP</button>
        <button class="tab" id="tabFachada" type="button">Por Fachada</button>
      </div>

      <!-- CEP -->
      <div id="paneCep">
        <div class="grid">
          <div>
            <label>CEP</label>
            <input id="cep" inputmode="numeric" placeholder="Ex.: 90001-970" maxlength="9" />
          </div>
          <div>
            <label>N√∫mero</label>
            <input id="numero" inputmode="numeric" placeholder="Ex.: 19" />
          </div>
        </div>

        <div class="grid">
          <div>
            <label>Complemento (opcional)</label>
            <input id="complemento" placeholder="Apto, casa, bloco..." />
          </div>
          <div>
            <label>Refer√™ncia (opcional)</label>
            <input id="referencia" placeholder="Perto de..." />
          </div>
        </div>

        <div class="actions">
          <button type="button" id="btnConsultarCep">Consultar</button>
          <button type="button" class="secondary" id="btnLimparCep">Limpar</button>
          <span class="muted" id="statusCep"></span>
        </div>

        <div class="result hide" id="resCep"></div>
      </div>

      <!-- FACHADA -->
      <div id="paneFachada" class="hide">
        <div class="grid">
          <div>
            <label>CEP (se souber)</label>
            <input id="cep2" inputmode="numeric" placeholder="Ex.: 90001-970" maxlength="9" />
          </div>
          <div>
            <label>N√∫mero (se souber)</label>
            <input id="numero2" inputmode="numeric" placeholder="Ex.: 19" />
          </div>
        </div>

        <label>Foto da fachada (jpg/png/webp)</label>
        <input id="foto" type="file" accept="image/*" />

        <label>Observa√ß√µes</label>
        <textarea id="obs" placeholder="Ex.: port√£o preto, placa 19, esquina com Rua X..."></textarea>

        <div class="actions">
          <button type="button" id="btnEnviarFachada">Enviar</button>
          <button type="button" class="secondary" id="btnLimparFachada">Limpar</button>
          <span class="muted" id="statusFachada"></span>
        </div>

        <div class="result hide" id="resFachada"></div>
      </div>

      <div class="muted" style="margin-top:14px;">
        Padr√£o do Firestore: cole√ß√£o <code>algar_enderecos</code> e docId <code>CEP|NUMERO</code> (ex.: <code>90001970|19</code>).
      </div>
    </div>
  </div>

<script type="module">
  // ---------------------------
  // Firebase SDK (Web v9+ modular)
  // ---------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  // ---------------------------
  // üî¥ TROQUE pelo config do projeto webturbo-crm
  // Firebase Console > Project settings > Your apps > Firebase SDK snippet (Config)
  // ---------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyB9nOa8MBenK0Ayp3bwYV-_L2zFoPTwcWI",
    authDomain: "webturbo-crm.firebaseapp.com",
    projectId: "webturbo-crm",
    storageBucket: "webturbo-crm.firebasestorage.app",
    messagingSenderId: "964927461432",
    appId: "1:964927461432:web:b3176b7e9f9566f057eecd"
  };

  // ---------------------------
  // Firestore/Storage init
  // ---------------------------
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ---------------------------
  // Conven√ß√µes do seu banco
  // ---------------------------
  const ALGAR_COLLECTION = "algar_enderecos";          // ‚úÖ conforme print
  const FACHADA_COLLECTION = "solicitacoes_fachada";   // voc√™ pode criar
  const FACHADA_STORAGE_PREFIX = "fachadas";           // pasta no Storage

  // ---------------------------
  // UI: Tabs
  // ---------------------------
  const tabCep = document.getElementById("tabCep");
  const tabFachada = document.getElementById("tabFachada");
  const paneCep = document.getElementById("paneCep");
  const paneFachada = document.getElementById("paneFachada");

  function setTab(which) {
    const isCep = which === "cep";
    tabCep.classList.toggle("active", isCep);
    tabFachada.classList.toggle("active", !isCep);
    paneCep.classList.toggle("hide", !isCep);
    paneFachada.classList.toggle("hide", isCep);
  }
  tabCep.addEventListener("click", () => setTab("cep"));
  tabFachada.addEventListener("click", () => setTab("fachada"));

  // ---------------------------
  // Helpers
  // ---------------------------
  function onlyDigits(s){ return (s||"").replace(/\D+/g,""); }
  function formatCep(v){
    const d = onlyDigits(v).slice(0,8);
    if (d.length <= 5) return d;
    return d.slice(0,5) + "-" + d.slice(5);
  }
  ["cep","cep2"].forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener("input", () => el.value = formatCep(el.value));
  });

  function show(el, html){ el.classList.remove("hide"); el.innerHTML = html; }
  function hide(el){ el.classList.add("hide"); el.innerHTML = ""; }

  function safeHtml(v){
    return String(v ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderCoberturaFromDoc(data){
    // Se existe doc => "COM COBERTURA"
    const municipio = safeHtml(data?.municipio || "");
    const uf = safeHtml(data?.uf || "");
    const cep = safeHtml(data?.cep || "");
    const numero = safeHtml(data?.numero || "");
    const atualizado = data?.atualizado_em ? safeHtml(data.atualizado_em) : "";

    return `
      <div>
        <span class="pill">Resultado</span>
        <span class="ok">COM COBERTURA</span>
      </div>
      <div class="muted" style="margin-top:6px;">
        Munic√≠pio: <strong>${municipio}</strong> ‚Äì ${uf}<br>
        CEP: ${cep} ‚Ä¢ N√∫mero: ${numero}
        ${atualizado ? `<br>Atualizado em: ${atualizado}` : ""}
      </div>
    `;
  }

  function renderSemCobertura(){
    return `
      <div>
        <span class="pill">Resultado</span>
        <span class="bad">SEM COBERTURA</span>
      </div>
      <div class="muted" style="margin-top:6px;">
        Endere√ßo n√£o encontrado na base da Algar para este CEP/n√∫mero.<br>
        Se necess√°rio, use a aba ‚ÄúPor Fachada‚Äù para solicitar an√°lise manual.
      </div>
    `;
  }

  // ---------------------------
  // CEP: consulta Firestore em algar_enderecos/{CEP|NUMERO}
  // ---------------------------
  const btnConsultarCep = document.getElementById("btnConsultarCep");
  const btnLimparCep = document.getElementById("btnLimparCep");
  const statusCep = document.getElementById("statusCep");
  const resCep = document.getElementById("resCep");

  btnLimparCep.addEventListener("click", () => {
    ["cep","numero","complemento","referencia"].forEach(id => document.getElementById(id).value = "");
    statusCep.textContent = "";
    hide(resCep);
  });

  btnConsultarCep.addEventListener("click", async () => {
    hide(resCep);

    const cep = onlyDigits(document.getElementById("cep").value);
    const numero = onlyDigits(document.getElementById("numero").value);

    if (cep.length !== 8) { show(resCep, `<span class="bad">CEP inv√°lido.</span>`); return; }
    if (!numero) { show(resCep, `<span class="bad">N√∫mero obrigat√≥rio.</span>`); return; }

    statusCep.innerHTML = `<span class="spinner"></span> Consultando...`;

    try {
      // ‚úÖ ID REAL DO SEU BANCO
      const docId = `${cep}|${numero}`;

      const snap = await getDoc(doc(db, ALGAR_COLLECTION, docId));

      statusCep.textContent = "";

      if (snap.exists()) {
        show(resCep, renderCoberturaFromDoc(snap.data()));
      } else {
        show(resCep, renderSemCobertura());
      }

    } catch (e) {
      statusCep.textContent = "";
      show(resCep, `<span class="bad">Erro:</span> ${safeHtml(e.message || e)}`);
    }
  });

  // ---------------------------
  // FACHADA: upload Storage + registrar solicita√ß√£o no Firestore
  // ---------------------------
  const btnEnviarFachada = document.getElementById("btnEnviarFachada");
  const btnLimparFachada = document.getElementById("btnLimparFachada");
  const statusFachada = document.getElementById("statusFachada");
  const resFachada = document.getElementById("resFachada");

  btnLimparFachada.addEventListener("click", () => {
    ["cep2","numero2","obs"].forEach(id => document.getElementById(id).value = "");
    document.getElementById("foto").value = "";
    statusFachada.textContent = "";
    hide(resFachada);
  });

  btnEnviarFachada.addEventListener("click", async () => {
    hide(resFachada);

    const cep = onlyDigits(document.getElementById("cep2").value);
    const numero = onlyDigits(document.getElementById("numero2").value);
    const obs = document.getElementById("obs").value.trim();
    const file = document.getElementById("foto").files?.[0];

    if (!file) { show(resFachada, `<span class="bad">Envie a foto da fachada.</span>`); return; }
    if (file.size > 6 * 1024 * 1024) { show(resFachada, `<span class="bad">Arquivo muito grande.</span> At√© 6MB.`); return; }

    statusFachada.innerHTML = `<span class="spinner"></span> Enviando...`;

    try {
      const protocolo = `FACH-${new Date().toISOString().replace(/[-:.TZ]/g,"").slice(0,14)}-${Math.random().toString(16).slice(2,8).toUpperCase()}`;

      const safeName = (file.name || "fachada").replace(/[^\w.\-]+/g, "_").slice(0,60);
      const path = `${FACHADA_STORAGE_PREFIX}/${protocolo}/${safeName}`;
      const storageRef = ref(storage, path);

      // Upload
      await uploadBytes(storageRef, file, { contentType: file.type || "application/octet-stream" });
      const fotoUrl = await getDownloadURL(storageRef);

      // Registrar solicita√ß√£o no Firestore
      await setDoc(doc(db, FACHADA_COLLECTION, protocolo), {
        protocolo,
        cep: cep || null,
        numero: numero || null,
        obs: obs || null,
        fotoUrl,
        storagePath: path,
        status: "EM_ANALISE",
        createdAt: serverTimestamp()
      });

      statusFachada.textContent = "";

      show(resFachada, `
        <div><span class="pill">Status</span> <span class="ok">ENVIADO PARA AN√ÅLISE</span></div>
        <div class="muted" style="margin-top:6px;">Protocolo: <strong>${safeHtml(protocolo)}</strong></div>
        <div class="muted" style="margin-top:6px;">Foto: <a href="${fotoUrl}" target="_blank" rel="noopener">abrir</a></div>
      `);

    } catch (e) {
      statusFachada.textContent = "";
      show(resFachada, `<span class="bad">Erro:</span> ${safeHtml(e.message || e)}`);
    }
  });
</script>
</body>
</html>
